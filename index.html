<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Waythes Calendrier</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #7289da, #99aab5);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #2c2f33;
      padding: 20px;
    }
    
    header {
      width: 100%;
      max-width: 900px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    h1 {
      font-size: 2rem;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    #user-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    #user-info img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      border: 2px solid #fff;
    }
    
    .badge {
      background: #5865f2;
      color: #fff;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .badge.admin {
      background: #e74c3c;
    }
    
    .badge.creator {
      background: #f39c12;
    }
    
    .badge.visitor {
      background: #95a5a6;
    }
    
    button {
      background: #5865f2;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    button:hover {
      background: #4752c4;
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .login-button {
      background: #7289da;
      padding: 12px 24px;
      font-size: 1.1rem;
      border-radius: 8px;
    }
    
    .login-button:hover {
      background: #677bc4;
    }
    
    .calendar {
      width: 100%;
      max-width: 900px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      margin-bottom: 40px;
    }
    
    .header-cal {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2c2f33;
      color: #fff;
      padding: 16px 24px;
    }
    
    .header-cal h2 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .nav-button {
      background: #7289da;
      padding: 10px 16px;
      font-weight: 600;
    }
    
    .nav-button:hover {
      background: #677bc4;
    }
    
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background-color: #f8f9fa;
    }
    
    .day-header {
      background: #36393f;
      color: #fff;
      font-weight: bold;
      text-align: center;
      padding: 12px 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .day {
      border: 1px solid #e1e8ed;
      min-height: 120px;
      position: relative;
      padding: 8px;
      background: #fff;
      transition: background-color 0.2s ease;
    }
    
    .day:hover {
      background: #f8f9fa;
    }
    
    .day.today {
      background: #e3f2fd;
      border-color: #2196f3;
    }
    
    .day strong {
      font-size: 1.1rem;
      color: #2c2f33;
    }
    
    .add-event-btn {
      background: #28a745;
      font-size: 0.8rem;
      padding: 4px 8px;
      margin-top: 6px;
      border-radius: 4px;
      display: block;
      width: 100%;
    }
    
    .add-event-btn:hover {
      background: #218838;
    }
    
    .event {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #7289da;
      color: #fff;
      padding: 6px 8px;
      border-radius: 6px;
      margin-top: 6px;
      font-size: 0.8rem;
      line-height: 1.2;
      word-wrap: break-word;
    }
    
    .event.pending {
      background: #faa61a;
    }
    
    .event.validated {
      background: #28a745;
    }
    
    .event-content {
      flex: 1;
      margin-right: 8px;
    }
    
    .event-status {
      font-size: 0.7rem;
      opacity: 0.9;
    }
    
    .event-actions {
      display: flex;
      gap: 4px;
    }
    
    .event button {
      background: rgba(255,255,255,0.2);
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
      min-width: 20px;
    }
    
    .event button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 6px;
      margin: 16px 0;
      border-left: 4px solid #dc3545;
    }
    
    @media (max-width: 768px) {
      h1 {
        font-size: 1.5rem;
      }
      
      .calendar {
        margin: 0 10px;
      }
      
      .day {
        min-height: 80px;
        padding: 4px;
      }
      
      .header-cal {
        padding: 12px 16px;
      }
      
      .header-cal h2 {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üìÖ Waythes Calendrier</h1>
    <div id="user-info"></div>
  </header>

  <div class="calendar">
    <div class="header-cal">
      <button id="prev-month" class="nav-button">‚Üê Pr√©c√©dent</button>
      <h2 id="month-year">Chargement...</h2>
      <button id="next-month" class="nav-button">Suivant ‚Üí</button>
    </div>
    <div id="calendar-days" class="days">
      <div class="loading">Chargement du calendrier...</div>
    </div>
  </div>

  <script>
    // Configuration
    const SUPABASE_URL = "https://fmzdijfbopwsionscrxn.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtemRpamZib3B3c2lvbnNjcnhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg5NzcxNTcsImV4cCI6MjA2NDU1MzE1N30.3csrcFWayjl4w-Rx7Pzj551axB-crMvghQyLgwnC0mQ";
    const CLIENT_ID = "1378637692169879632";
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPE = "identify email";

    // Initialisation Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variables globales
    let currentUser = null;
    let curYear, curMonth;
    const today = new Date();
    curYear = today.getFullYear();
    curMonth = today.getMonth();

    // Utilitaires
    function parseHash(hashString) {
      const params = {};
      if (hashString.startsWith("#")) {
        hashString.substring(1).split("&").forEach(pair => {
          const [k, v] = pair.split("=");
          params[k] = decodeURIComponent(v || "");
        });
      }
      return params;
    }

    function showError(message) {
      console.error(message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = `Erreur: ${message}`;
      document.body.insertBefore(errorDiv, document.querySelector('.calendar'));
      setTimeout(() => errorDiv.remove(), 5000);
    }

    function formatDiscordUsername(user) {
      if (user.discriminator && user.discriminator !== '0') {
        return `${user.username}#${user.discriminator}`;
      }
      return user.username;
    }

    // Gestion de l'authentification Discord
    async function handleDiscordRedirect() {
      if (window.location.hash.includes("access_token=")) {
        const params = parseHash(window.location.hash);
        const accessToken = params.access_token;
        
        // Nettoyer l'URL
        history.replaceState(null, "", window.location.pathname);
        
        try {
          // R√©cup√©rer les infos utilisateur Discord
          const userRes = await fetch("https://discord.com/api/users/@me", {
            headers: { Authorization: `Bearer ${accessToken}` },
          });
          
          if (!userRes.ok) throw new Error("Erreur API Discord");
          
          const discordUser = await userRes.json();
          
          const newUser = {
            id: discordUser.id,
            username: formatDiscordUsername(discordUser),
            avatar: discordUser.avatar,
            email: discordUser.email,
            role: "visitor",
          };

          // Sauvegarder en base
          const { data, error } = await supabaseClient
            .from("users")
            .upsert(newUser, { onConflict: "id" })
            .select()
            .single();

          if (error) throw error;

          currentUser = data;
          renderUserInfo();
          renderCalendar();
          
        } catch (err) {
          showError(err.message);
        }
      }
    }

    // Interface utilisateur
    function renderUserInfo() {
      const container = document.getElementById("user-info");
      if (!container) return;
      
      container.innerHTML = "";

      if (!currentUser) {
        const btn = document.createElement("button");
        btn.className = "login-button";
        btn.textContent = "üîó Se connecter avec Discord";
        btn.onclick = () => {
          const authUrl = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPE)}`;
          window.location.href = authUrl;
        };
        container.appendChild(btn);
        return;
      }

      const avatarUrl = currentUser.avatar
        ? `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png?size=64`
        : "https://cdn.discordapp.com/embed/avatars/0.png";

      const wrapper = document.createElement("div");
      wrapper.style.display = "flex";
      wrapper.style.alignItems = "center";
      wrapper.style.gap = "12px";

      const img = document.createElement("img");
      img.src = avatarUrl;
      img.alt = "Avatar Discord";
      img.onerror = () => {
        img.src = "https://cdn.discordapp.com/embed/avatars/0.png";
      };

      const nameSpan = document.createElement("span");
      nameSpan.textContent = currentUser.username;
      nameSpan.style.color = "#fff";
      nameSpan.style.fontWeight = "600";

      const badge = document.createElement("span");
      badge.className = `badge ${currentUser.role}`;
      badge.textContent = currentUser.role;

      const logoutBtn = document.createElement("button");
      logoutBtn.textContent = "D√©connexion";
      logoutBtn.onclick = () => {
        currentUser = null;
        renderUserInfo();
        renderCalendar();
      };

      wrapper.append(img, nameSpan, badge, logoutBtn);
      container.appendChild(wrapper);
    }

    // Gestion des √©v√©nements
    async function fetchEvents(monthStr) {
      try {
        const { data, error } = await supabaseClient
          .from("events")
          .select("*")
          .like("date", `${monthStr}%`)
          .order("date", { ascending: true });

        if (error) throw error;
        return data || [];
      } catch (err) {
        showError("Erreur lors du chargement des √©v√©nements");
        return [];
      }
    }

    async function createEvent(date, title) {
      if (!currentUser || !["creator", "admin"].includes(currentUser.role)) {
        showError("Vous n'avez pas les permissions pour cr√©er un √©v√©nement");
        return;
      }

      try {
        const { error } = await supabaseClient
          .from("events")
          .insert([{
            user_id: currentUser.id,
            date,
            title,
            validated: currentUser.role === "admin"
          }]);

        if (error) throw error;
        await renderCalendar();
      } catch (err) {
        showError("Erreur lors de la cr√©ation de l'√©v√©nement");
      }
    }

    async function validateEvent(id) {
      if (!currentUser || currentUser.role !== "admin") return;

      try {
        const { error } = await supabaseClient
          .from("events")
          .update({ validated: true })
          .eq("id", id);

        if (error) throw error;
        await renderCalendar();
      } catch (err) {
        showError("Erreur lors de la validation");
      }
    }

    async function deleteEvent(id) {
      if (!currentUser || currentUser.role !== "admin") return;

      try {
        const { error } = await supabaseClient
          .from("events")
          .delete()
          .eq("id", id);

        if (error) throw error;
        await renderCalendar();
      } catch (err) {
        showError("Erreur lors de la suppression");
      }
    }

    // Rendu du calendrier
    async function renderCalendar() {
      const container = document.getElementById("calendar-days");
      const headerEl = document.getElementById("month-year");
      
      if (!container || !headerEl) return;

      // Affichage du mois/ann√©e
      const dateObj = new Date(curYear, curMonth);
      const monthName = dateObj.toLocaleString("fr-FR", { month: "long" });
      headerEl.textContent = `${monthName.charAt(0).toUpperCase()}${monthName.slice(1)} ${curYear}`;

      // Calculs du calendrier
      const firstDay = new Date(curYear, curMonth, 1).getDay();
      const offset = firstDay === 0 ? 6 : firstDay - 1;
      const totalDays = new Date(curYear, curMonth + 1, 0).getDate();

      container.innerHTML = "";

      // En-t√™tes des jours
      const dayNames = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"];
      dayNames.forEach(dayName => {
        const header = document.createElement("div");
        header.className = "day-header";
        header.textContent = dayName;
        container.appendChild(header);
      });

      // Cases vides d√©but de mois
      for (let i = 0; i < offset; i++) {
        const empty = document.createElement("div");
        empty.className = "day";
        container.appendChild(empty);
      }

      // R√©cup√©ration des √©v√©nements
      const monthStr = `${curYear}-${String(curMonth + 1).padStart(2, "0")}`;
      const events = await fetchEvents(monthStr);

      // Jours du mois
      const todayStr = today.toISOString().split('T')[0];
      
      for (let day = 1; day <= totalDays; day++) {
        const fullDate = `${monthStr}-${String(day).padStart(2, "0")}`;
        const cell = document.createElement("div");
        cell.className = "day";
        cell.dataset.date = fullDate;
        
        if (fullDate === todayStr) {
          cell.classList.add("today");
        }

        const dayNumber = document.createElement("strong");
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        // Bouton d'ajout d'√©v√©nement
        if (currentUser && ["creator", "admin"].includes(currentUser.role)) {
          const addBtn = document.createElement("button");
          addBtn.className = "add-event-btn";
          addBtn.textContent = "+ Ajouter √©v√©nement";
          addBtn.onclick = () => {
            const title = prompt(`Titre de l'√©v√©nement pour le ${day}/${curMonth + 1}/${curYear} :`);
            if (title && title.trim()) {
              createEvent(fullDate, title.trim());
            }
          };
          cell.appendChild(addBtn);
        }

        // √âv√©nements du jour
        const dayEvents = events.filter(e => e.date === fullDate);
        dayEvents.forEach(event => {
          const eventDiv = document.createElement("div");
          eventDiv.className = `event ${event.validated ? 'validated' : 'pending'}`;

          const eventContent = document.createElement("div");
          eventContent.className = "event-content";
          eventContent.innerHTML = `
            ${event.title}
            ${!event.validated ? '<div class="event-status">‚è≥ En attente</div>' : '<div class="event-status">‚úÖ Valid√©</div>'}
          `;

          eventDiv.appendChild(eventContent);

          // Actions admin
          if (currentUser && currentUser.role === "admin") {
            const actions = document.createElement("div");
            actions.className = "event-actions";

            if (!event.validated) {
              const validateBtn = document.createElement("button");
              validateBtn.textContent = "‚úì";
              validateBtn.title = "Valider";
              validateBtn.onclick = (e) => {
                e.stopPropagation();
                validateEvent(event.id);
              };
              actions.appendChild(validateBtn);
            }

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "‚úï";
            deleteBtn.title = "Supprimer";
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              if (confirm(`Supprimer l'√©v√©nement "${event.title}" ?`)) {
                deleteEvent(event.id);
              }
            };
            actions.appendChild(deleteBtn);

            eventDiv.appendChild(actions);
          }

          cell.appendChild(eventDiv);
        });

        container.appendChild(cell);
      }
    }

    // Navigation du calendrier
    document.getElementById("prev-month").onclick = () => {
      curMonth--;
      if (curMonth < 0) {
        curMonth = 11;
        curYear--;
      }
      renderCalendar();
    };

    document.getElementById("next-month").onclick = () => {
      curMonth++;
      if (curMonth > 11) {
        curMonth = 0;
        curYear++;
      }
      renderCalendar();
    };

    // Initialisation
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await handleDiscordRedirect();
        renderUserInfo();
        renderCalendar();
      } catch (err) {
        showError("Erreur lors de l'initialisation");
      }
    });
  </script>
</body>
</html>
